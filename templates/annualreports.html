<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Annual Reports | Aditya University</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        /* --- REUSING CORE STYLES --- */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Outfit', sans-serif; }
        body { background-color: #f0f2f5; color: #333; }
        :root { --primary: #003366; --accent: #d32f2f; }

        /* --- NAVBAR --- */
        .navbar { background: white; height: 70px; display: flex; align-items: center; padding: 0 40px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 1000; }
        .nav-content { width: 100%; max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo { display: flex; align-items: center; gap: 12px; font-size: 22px; font-weight: 800; color: var(--primary); }
        .logo span { color: var(--accent); }
        .nav-links a { text-decoration: none; color: #333; font-weight: 600; margin-left: 30px; font-size: 14px; transition: color 0.3s; }
        .nav-links a:hover { color: var(--primary); }

        /* --- LAYOUT --- */
        .container { max-width: 1400px; margin: 0 auto; padding: 40px 20px; display: flex; gap: 30px; }
        
        /* Sidebar */
        .sidebar { width: 280px; flex-shrink: 0; }
        .glass-panel { background: white; border-radius: 16px; box-shadow: 0 10px 30px rgba(0,0,0,0.04); border: 1px solid rgba(0,0,0,0.05); overflow: hidden; }
        .menu-item { display: flex; align-items: center; gap: 12px; padding: 15px 20px; color: #64748b; text-decoration: none; font-weight: 500; transition: 0.3s; border-left: 4px solid transparent; }
        .menu-item:hover, .menu-item.active { background: #eff6ff; color: var(--primary); border-left-color: var(--primary); }

        /* Main Content */
        .content { flex: 1; }
        .page-header { margin-bottom: 30px; }
        .page-header h1 { font-size: 28px; color: var(--primary); font-weight: 700; }
        .page-header p { color: #64748b; font-size: 14px; margin-top: 5px; }

        /* --- CHARTS GRID --- */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr); /* 2 Columns */
            gap: 25px;
        }

        .chart-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
            border: 1px solid #f1f5f9;
            height: 400px; /* Fixed height for uniformity */
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-size: 16px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chart-container {
            flex: 1;
            position: relative;
            width: 100%;
            height: 100%;
        }

        /* Loading State */
        #loader { text-align: center; padding: 100px; width: 100%; }
        .spinner { animation: spin 1s linear infinite; font-size: 40px; color: var(--primary); }
        @keyframes spin { 100% { transform: rotate(360deg); } }

    </style>
</head>
<body>

    <nav class="navbar">
        <div class="nav-content">
            <div class="logo">
                <i class="fa-solid fa-university"></i>
                ADITYA <span>UNIVERSITY</span>
            </div>
            <div class="nav-links">
               <a href="/home">Home</a>
               <a href="/reports" style="color: var(--primary);">Reports</a>
               <a href="/logout" style="color: var(--accent);">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <aside class="sidebar">
            <div class="glass-panel">
                <div class="p-6 text-center border-b border-gray-100">
                    <h3 class="font-bold text-lg text-blue-900">Analytics Hub</h3>
                    <p class="text-xs text-gray-500">2025-26 Academic Year</p>
                </div>
                <div class="py-2">
                    <a href="/home" class="menu-item"><i class="fa-solid fa-arrow-left"></i> Back to Dashboard</a>
                    <a href="#" class="menu-item active"><i class="fa-solid fa-chart-pie"></i> Annual Overview</a>
                    <a href="#" class="menu-item"><i class="fa-solid fa-file-arrow-down"></i> Export PDF</a>
                </div>
            </div>
        </aside>

        <main class="content">
            <div class="page-header">
                <h1>Annual Participation Report</h1>
                <p>Aggregated data across all registered clubs and events.</p>
            </div>

            <div id="loader">
                <i class="fa-solid fa-circle-notch spinner"></i>
                <p class="mt-4 text-gray-500 text-sm font-semibold">Processing Data...</p>
            </div>

            <div class="charts-grid hidden" id="chartsArea">
                
                <div class="chart-card">
                    <div class="chart-title">
                        Events vs Participants
                        <i class="fa-solid fa-users text-blue-200"></i>
                    </div>
                    <div class="chart-container">
                        <canvas id="eventChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        Schools vs Participants
                        <i class="fa-solid fa-school text-green-200"></i>
                    </div>
                    <div class="chart-container">
                        <canvas id="schoolChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        Departments vs Participants
                        <i class="fa-solid fa-building-user text-purple-200"></i>
                    </div>
                    <div class="chart-container">
                        <canvas id="deptChart"></canvas>
                    </div>
                </div>

                <div class="chart-card">
                    <div class="chart-title">
                        Year of Study vs Participants
                        <i class="fa-solid fa-graduation-cap text-orange-200"></i>
                    </div>
                    <div class="chart-container">
                        <canvas id="yearChart"></canvas>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', loadAnalytics);

        async function loadAnalytics() {
            try {
                const response = await fetch('/api/stats/annual');
                const data = await response.json();

                if (data.error) throw new Error(data.error);

                document.getElementById('loader').classList.add('hidden');
                document.getElementById('chartsArea').classList.remove('hidden');
                document.getElementById('chartsArea').classList.add('grid'); // Ensure grid layout applies

                // Common Options for Style
                const commonOptions = {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                    },
                    scales: {
                        y: { beginAtZero: true, grid: { color: '#f3f4f6' } },
                        x: { grid: { display: false } }
                    }
                };

                // 1. Events Chart (Bar)
                new Chart(document.getElementById('eventChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.events),
                        datasets: [{
                            label: 'Participants',
                            data: Object.values(data.events),
                            backgroundColor: '#3b82f6',
                            borderRadius: 6
                        }]
                    },
                    options: commonOptions
                });

                // 2. Schools Chart (Horizontal Bar for long names)
                new Chart(document.getElementById('schoolChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.schools),
                        datasets: [{
                            label: 'Students',
                            data: Object.values(data.schools),
                            backgroundColor: '#10b981',
                            borderRadius: 6
                        }]
                    },
                    options: { ...commonOptions, indexAxis: 'y' }
                });

                // 3. Departments Chart (Bar)
                new Chart(document.getElementById('deptChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.departments),
                        datasets: [{
                            label: 'Students',
                            data: Object.values(data.departments),
                            backgroundColor: '#8b5cf6',
                            borderRadius: 6
                        }]
                    },
                    options: commonOptions
                });

                // 4. Year Chart (Doughnut or Bar - Bar is clearer for comparison)
                new Chart(document.getElementById('yearChart'), {
                    type: 'bar',
                    data: {
                        labels: Object.keys(data.years),
                        datasets: [{
                            label: 'Students',
                            data: Object.values(data.years),
                            backgroundColor: ['#f97316', '#f59e0b', '#eab308', '#84cc16'],
                            borderRadius: 6
                        }]
                    },
                    options: commonOptions
                });

            } catch (error) {
                console.error("Error loading charts:", error);
                document.getElementById('loader').innerHTML = `<p class="text-red-500">Failed to load data. Please try again.</p>`;
            }
        }
    </script>
</body>
</html>